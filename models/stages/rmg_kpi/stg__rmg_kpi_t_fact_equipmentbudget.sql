{{
  config(
    materialized = 'table',tags = ['rmg_kpi']
    )
}}

WITH budget_machine_equipment AS (
    SELECT DISTINCT
        FISCYEAR AS fiscal_year,
        fmfctrt.MCTXT AS financial_center_description,
        fmbl.FUNDSCTR AS financial_center_code,
        CMMTITEM AS commitment_item_code,
        fmcit.TEXT1 AS commitment_item_definition,
        CONCAT(FISCYEAR, '-', RIGHT('0' + CAST(MonthValues.month AS VARCHAR(2)), 2)) AS year_month,
        MonthValues.[month],
        SUM(        
            CASE 
                WHEN RIGHT(MonthValues.Value,1) = '-'
                THEN -1*cast(replace(MonthValues.Value,'-','') as money)
                else cast (MonthValues.Value as money)
            END
            ) AS budget
        --,budget_version = REPLACE(fmbh.[version],'Q','V')
    FROM {{ source('stg_s4_odata', 'raw__s4hana_t_sap_fmbl') }} fmbl
        LEFT JOIN {{ source('stg_s4_odata', 'raw__s4hana_t_sap_fmfctrt') }} fmfctrt ON fmfctrt.FICTR = fmbl.FUNDSCTR
        LEFT JOIN {{ source('stg_s4_odata', 'raw__s4hana_t_sap_fmcit') }} fmcit ON fmbl.CMMTITEM = fmcit.FIPEX
        RIGHT JOIN ( -- Bütçe Versiyonları Buradan Gelmektedir
            SELECT distinct docnr,docyear,[version] 
            FROM {{ source('stg_s4_odata', 'raw__s4hana_t_sap_fmbh') }}
            WHERE 1=1
                AND [version] <> '0'
		        AND [version] <> 'R0'
        ) fmbh ON fmbl.docnr= fmbh.docnr and fmbh.docyear = fmbl.docyear
        CROSS APPLY (
            VALUES
                (1, fmbl.TVAL01),
                (2, fmbl.TVAL02),
                (3, fmbl.TVAL03),
                (4, fmbl.TVAL04),
                (5, fmbl.TVAL05),
                (6, fmbl.TVAL06),
                (7, fmbl.TVAL07),
                (8, fmbl.TVAL08),
                (9, fmbl.TVAL09),
                (10, fmbl.TVAL10),
                (11, fmbl.TVAL11),
                (12, fmbl.TVAL12)
        ) AS MonthValues (month, Value)

    GROUP BY
        fmbl.FUNDSCTR,
        fmfctrt.MCTXT,
        fmbl.CMMTITEM,
        fmcit.TEXT1,
        FISCYEAR,
        CONCAT(FISCYEAR, '-', RIGHT('0' + CAST(MonthValues.month AS VARCHAR(2)), 2)),
        MonthValues.[month],
        fmbh.[version]
),

currency AS (
	SELECT 
		YEAR(CONVERT(DATE, gdatu, 104)) AS [year],
		MONTH(CONVERT(DATE, gdatu, 104)) AS [month],
		CONVERT(DATE, gdatu, 104) AS full_date,
		FCURR,
		CAST(UKURS AS MONEY) AS rate
	FROM {{ source('stg_s4_odata', 'raw__s4hana_t_sap_tcurr') }} AS T
	WHERE 1=1
		AND (TCURR = 'TRY') 
		AND (KURST = 'BTG') 
),

min_date AS (
	SELECT
		[year],
		[month],
		MIN(full_date) AS first_day
	FROM currency
	GROUP BY [year], [month]
),

currencies AS(
	SELECT 
		md.[year], 
		md.[month], 
		md.first_day,
		MAX(CASE WHEN c.FCURR = 'EUR' THEN c.rate END) AS try_value,
		MAX(CASE WHEN c.FCURR = 'USD' THEN c.rate END) AS usd_value
	FROM min_date md
	JOIN currency c ON md.[year] = c.[year] 
					AND md.[month] = c.[month] 
					AND md.first_day = c.full_date
	GROUP BY md.[year], md.[month], md.first_day
)

SELECT
	 fiscal_year
    ,financial_center_description
    ,financial_center_code
    ,commitment_item_code
    ,commitment_item_definition
    ,year_month
    ,budget.[month]
	,budget = budget * try_value
	,budget_eur = budget
	,tag= 'expense'
FROM budget_machine_equipment budget
LEFT JOIN currencies ON budget.fiscal_year = currencies.[year]
					 AND budget.[month] = currencies.[month]
WHERE 1=1

	AND commitment_item_code IN (
		N'500203000',
		N'500104030',
		N'500102080',
		N'500104080',
		N'500104040',
		N'500104010',
		N'500101040',
		N'500201000',
		N'500104050',
		N'500104020',
		N'500104090',
		N'500501000'
	)

	AND financial_center_code IN (
		N'ATL-DESTEK',
		N'MBP-3005',
		N'KMY-4047',
		N'TRD-6311',
		N'KMY-4022',
		N'MİX-3506',
		N'TRD-6327',
		N'KMY-4016',
		N'HIZMET',
		N'KMY-4023',
		N'MBP-3003',
		N'AKT-6606',
		N'MBP-3004',
		N'LOA-2610',
		N'TRR-5516',
		N'TRK-5037',
		N'TRD-6317',
		N'KMT-R017',
		N'MBP-3006',
		N'EXC-2817',
		N'TIR-6034',
		N'KMY-4053',
		N'FRK-9901',
		N'MİX-3527',
		N'KMT-R013',
		N'MBP-3002',
		N'MİX-3536',
		N'JNR-9021',
		N'VHİ-705',
		N'EXC-2818',
		N'AKT-6604',
		N'MİX-3532',
		N'ARZ-9106',
		N'FRK-9904',
		N'TIR-6013',
		N'KMY-4054',
		N'EXC-2822',
		N'MİX-3539',
		N'KMY-4058',
		N'KMY-4052',
		N'FOR-2903',
		N'TRD-6334',
		N'EXC-2829',
		N'MİX-3502',
		N'LOA-2613',
		N'LOA-2614',
		N'MİX-3504',
		N'EXC-2825',
		N'BCH-2311',
		N'MİX-3531',
		N'KMY-4035',
		N'KMY-4060',
		N'TIR-6022',
		N'KMY-4037',
		N'KMY-4066',
		N'MİX-3529',
		N'KMY-4068',
		N'MİX-3542',
		N'MİX-3535',
		N'MİX-3510',
		N'KMY-4057',
		N'TRD-6319',
		N'KMY-4064',
		N'TRD-6330',
		N'KMT-4505',
		N'KMY-4061',
		N'BCH-2314',
		N'KMY-4046',
		N'EXC-2805',
		N'MBP-3001',
		N'KMY-4024',
		N'TRK-5031',
		N'KMT-R016',
		N'FRK-9902',
		N'MİX-3544',
		N'KMT-R014',
		N'TIR-6021',
		N'MİX-3519',
		N'TRD-6332',
		N'MİX-3507',
		N'EXC-2827',
		N'KMY-4069',
		N'VKU-0130',
		N'ATOLYE',
		N'KMY-4015',
		N'LOA-2605',
		N'MİX-3523',
		N'KMY-4033',
		N'KMY-4026',
		N'KMY-4031',
		N'TIR-6036',
		N'TIR-6012',
		N'ARZ-9103',
		N'VHİ-701',
		N'MİX-3509',
		N'MİX-3541',
		N'KMY-4028',
		N'TRD-6316',
		N'KMY-4039',
		N'LOA-2606',
		N'TIR-6006',
		N'MİX-3505',
		N'EXC-2830',
		N'TIR-6035',
		N'MİX-3530',
		N'BCH-2315',
		N'GRY-2902',
		N'BOB-2012',
		N'KMY-4071',
		N'TLF-1001',
		N'MBS-5004',
		N'MİX-3501',
		N'RCK-0104',
		N'ATL-MAG-TPR',
		N'MİX-3513',
		N'TRK-5011',
		N'KMT-4511',
		N'MİX-3546',
		N'TRD-6320',
		N'GRY-2903',
		N'KMT-4507',
		N'AKT-6601',
		N'MİX-3543',
		N'MİX-3514',
		N'TIR-6011',
		N'MİX-3540',
		N'EXC-2816',
		N'MİX-3521',
		N'KMY-4062',
		N'TRD-6336',
		N'MİX-3515',
		N'KMY-4055',
		N'TIR-6027',
		N'KMT-4503',
		N'KMY-4045',
		N'MİX-3528',
		N'KMY-4013',
		N'MİX-3520',
		N'EXC-2832',
		N'JNR-9020',
		N'KMY-4050',
		N'EXC-2831',
		N'KMY-4025',
		N'VKU-0152',
		N'KMY-4044',
		N'TLF-1019',
		N'TIR-6033',
		N'KMY-4049',
		N'MİX-3511',
		N'MİX-3522',
		N'KMY-4067',
		N'MİX-3533',
		N'LOA-2607',
		N'VKU-0163',
		N'TIR-6037',
		N'MİX-3517',
		N'KMY-4038',
		N'LOA-2608',
		N'EXC-2820',
		N'MİX-3524',
		N'ATL-MAG-ZEM',
		N'KMY-4041',
		N'KMY-4056',
		N'TIR-6028',
		N'RCK-0103',
		N'MİX-3518',
		N'MİX-3508',
		N'BCH-2312',
		N'JNR-9022',
		N'VKU-0146',
		N'KMY-4048',
		N'TIR-6031',
		N'TIR-6010',
		N'MİX-3503',
		N'VMO-301',
		N'TIR-6039',
		N'EXC-2826',
		N'TRK-5007',
		N'TRD-6310',
		N'TRD-6309',
		N'TRD-6305',
		N'TRK-5030',
		N'ARZ-9105',
		N'MBP-3007',
		N'VHİ-703',
		N'MİX-3547',
		N'KMY-4021',
		N'KMY-4059',
		N'LOA-2612',
		N'MİX-3516',
		N'ARZ-9101',
		N'VKU-0147',
		N'KMY-4051',
		N'FOR-2902',
		N'KMY-4034',
		N'AKT-6602',
		N'JNR-9026',
		N'EXC-2803',
		N'TRD-6312',
		N'KMY-4036',
		N'TLF-1002',
		N'TRD-6335',
		N'EXC-2804',
		N'EXC-2813',
		N'MBS-5002',
		N'TRD-6306',
		N'MİX-3526',
		N'MİX-3512',
		N'TRK-5005',
		N'KMY-4042',
		N'TRD-6314',
		N'MİX-3538',
		N'TIR-6016',
		N'TIR-6018',
		N'KMY-4027',
		N'KMY-4065',
		N'TRD-6313',
		N'KMY-4070',
		N'MLZ-ISG',
		N'MİX-3537',
		N'TIR-6026',
		N'TIR-6024',
		N'FRK-9903',
		N'EXC-2834',
		N'TIR-6009',
		N'MİX-3534',
		N'TRD-6331',
		N'ARZ-9104',
		N'TRK-5036',
		N'TRD-6322',
		N'TIR-6032',
		N'DBM-8602',
		N'BKM-8501',
		N'KMT-R012',
		N'VHİ-702',
		N'EXC-2824',
		N'TIR-6023',
		N'JNR-9031',
		N'TIR-6015',
		N'KMY-4063',
		N'KMY-4020',
		N'AKT-6603',
		N'TRK-5010',
		N'AKT-6605',
		N'EXC-2833',
		N'JNR-9017',
		N'HZM-MAG-ZEM',
		N'KMY-4040',
		N'MİX-3525',
		N'EXC-2828',
		N'KMY-4043',
		N'TRD-6326',
		N'TRD-6321',
		N'TRD-6304',
		N'DUMMY',
		N'KMY-4018',
		N'TRK-5017',
		N'KMY-4017',
		N'HZM-KIR',
		N'ASİ-8202',
		N'KMY-4032'
		)

UNION ALL

SELECT
	 fiscal_year
    ,financial_center_description
    ,financial_center_code
    ,commitment_item_code
    ,commitment_item_definition
    ,year_month
    ,budget.[month]
	,budget = budget * try_value
	,budget_eur = budget
	,tag= 'revenue'
FROM budget_machine_equipment budget
LEFT JOIN currencies ON budget.fiscal_year = currencies.[year]
					 AND budget.[month] = currencies.[month]
WHERE 1=1

	AND commitment_item_code IN (
	'501101010',
	'801100100',
	'801100120',
	'801100110',
	'500101010'
	)

	AND financial_center_code IN (
	N'ASA-9603',
	N'ASA-9604',
	N'ASA-9602',
	N'ASA-9601',
	N'RMGAMB000',
	N'FOR-2902',
	N'KMY-4059',
	N'MİX-3526',
	N'MİX-3544',
	N'EXC-2827',
	N'ARZ-9105',
	N'EXC-2830',
	N'EXC-2829',
	N'MİX-3540',
	N'EXC-2826',
	N'TIR-6026',
	N'MİX-3522',
	N'EXC-2813',
	N'VHİ-705',
	N'ARZ-9103',
	N'EXC-2825',
	N'TIR-6033',
	N'EXC-2833',
	N'LOA-2615',
	N'MBS-5005',
	N'MİX-3541',
	N'VHİ-702',
	N'MBS-5002',
	N'MİX-3531',
	N'MİX-3520',
	N'KMY-4071',
	N'RCK-R103',
	N'KMY-4060',
	N'MİX-3519',
	N'VHİ-701',
	N'VKU-0176',
	N'EXC-2817',
	N'AKT-6606',
	N'VHİ-703',
	N'VKU-0147',
	N'KMY-4050',
	N'LOA-2613',
	N'LOA-2610',
	N'MİX-3523',
	N'MİX-3530',
	N'BCH-2311',
	N'AKT-6605',
	N'KMY-4049',
	N'KMY-4056',
	N'KMY-4023',
	N'MİX-3534',
	N'BUM-8801',
	N'TLF-1012',
	N'MİX-3521',
	N'TIR-6027',
	N'EXC-2824',
	N'VKU-R2418',
	N'MİX-3516',
	N'AKT-6603',
	N'MİX-3546',
	N'LOA-2612',
	N'KMY-4069',
	N'ARZ-9104',
	N'MİX-3545',
	N'VKU-0154',
	N'MİX-3528',
	N'VHİ-704',
	N'MBP-3007',
	N'MİX-3543',
	N'MİX-3527',
	N'MİX-3533',
	N'TLF-1016',
	N'AKT-6604',
	N'KMY-4046',
	N'LOA-2614',
	N'KMY-4053',
	N'MİX-3529',
	N'MİX-3536',
	N'MİX-3535',
	N'KMY-4047',
	N'VKU-0179',
	N'VKU-0173',
	N'VKU-0172',
	N'KMY-4048',
	N'MİX-3542',
	N'VKU-0177',
	N'BCH-2315',
	N'RCK-0104',
	N'KMY-4065',
	N'MİX-3547',
	N'BCH-2314',
	N'MBP-3006',
	N'EXC-2832',
	N'KMY-4034',
	N'MBP-3004',
	N'MİX-3538',
	N'MİX-3539',
	N'GRY-2903',
	N'KMY-4051',
	N'KMY-4058',
	N'VKU-0174',
	N'LOA-2611',
	N'KMY-4061',
	N'MİX-3532',
	N'MİX-3524',
	N'MİX-3537',
	N'KMY-4068',
	N'BCH-2312',
	N'MİX-3525',
	N'EXC-2822',
	N'KMY-4021',
	N'TLF-1019',
	N'EXC-2834',
	N'LOA-2605',
	N'KMY-4037',
	N'MİX-3513',
	N'VKRU-2404',
	N'MİX-3508',
	N'MİX-3511',
	N'MİX-3514',
	N'MİX-3510',
	N'VKU-0105',
	N'VKU-0167',
	N'VKU-0130',
	N'MİX-3506',
	N'MİX-3509',
	N'VKU-0150',
	N'MİX-3505',
	N'MBP-3001',
	N'LOA-2606',
	N'VKU-0165',
	N'MİX-3512',
	N'MBP-3003',
	N'MİX-3515',
	N'MİX-3518',
	N'VKU-0145',
	N'VKRU-2402',
	N'VKU-0170',
	N'VKU-0169',
	N'JNR-9019',
	N'MBP-3005',
	N'VKU-0146',
	N'VKU-0151',
	N'VKU-0171',
	N'VKU-0141',
	N'VKU-0144',
	N'VKU-0156',
	N'VKU-0148',
	N'JNR-9017',
	N'VKU-0160',
	N'LOA-2609',
	N'VKU-0162',
	N'VKU-R2419',
	N'VKU-0180',
	N'VKU-0175',
	N'VKU-0166',
	N'VKU-0152',
	N'VKU-0139',
	N'VKU-0159',
	N'VKU-0149',
	N'VKU-0185',
	N'TRR-5516',
	N'VKU-0157',
	N'MİX-3502',
	N'VKU-0142',
	N'VKU-R2405',
	N'VKU-0140',
	N'VKU-0178',
	N'VKU-0155',
	N'VKU-0163',
	N'MİX-3504',
	N'VKU-0181',
	N'VKU-0183',
	N'VKU-0164',
	N'VKU-R2406',
	N'VKU-0137',
	N'KON-8601',
	N'VKU-0168',
	N'MPL-8701',
	N'EXC-2816',
	N'TLF-1017',
	N'VKRU-2403',
	N'VKU-0138',
	N'TRK-5011',
	N'MİX-3501',
	N'VKU-0182',
	N'TRK-5031',
	N'TRR-5513',
	N'MİX-3507',
	N'VKU-0153',
	N'VKU-0161',
	N'MBP-3002',
	N'MİX-3503',
	N'VKU-0184',
	N'VKU-0143',
	N'VKU-0158',
	N'KMY-4026',
	N'KMY-4028',
	N'TRK-5017',
	N'TLF-1018'
)